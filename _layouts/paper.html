<!-- LAYOUT: paper | Academic papers & books | DESIGN.md 255 Map -->
<!-- Standalone (no nested includes — avoids Liquid stack overflow on long documents) -->
<!-- Uses same CSS classes as post.html; same 17-type figure dispatch as DECK.html -->
{% assign scope_key = page.scope | default: site.scope | downcase %}
{% assign scope_up = page.scope | default: site.scope | upcase %}
{% assign fleet = site.data.fleet %}
{% assign accent = page.accent | default: site.accent | default: "#60a5fa" %}
{% assign accent_rgb = page.accent_rgb | default: site.accent_rgb | default: "59,130,246" %}
<!DOCTYPE html>
<html lang="en" data-scope="{{ scope_key }}">
<head>
  {% include HEAD.html title=page.title description=page.description %}
  {% assign deps = site.data.deps %}
  {% if page.math %}
  <!-- KaTeX (conditional) — governed by DEPS.md -->
  <link rel="stylesheet" href="{{ deps.katex.css }}" integrity="{{ deps.katex.css_integrity }}" crossorigin="anonymous">
  <script defer src="{{ deps.katex.js }}" integrity="{{ deps.katex.js_integrity }}" crossorigin="anonymous"></script>
  <script defer src="{{ deps.katex.auto_render }}" integrity="{{ deps.katex.auto_render_integrity }}" crossorigin="anonymous"
    onload="renderMathInElement(document.body, {
      delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '$', right: '$', display: false},
        {left: '\\[', right: '\\]', display: true},
        {left: '\\(', right: '\\)', display: false}
      ],
      throwOnError: false
    });"></script>
  {% endif %}
</head>
<body class="post-page paper-page">

  <!-- NAV: inline (same classes as NAV-UNIFIED.html post mode) -->
  <header class="nav" id="nav" role="navigation">
    <div class="nav-left">
      <button class="nav-brand" id="navBrand" type="button" aria-label="Fleet menu" aria-expanded="false">
        <span class="nav-mark">{{ fleet.brand.mark | default: "∩" }}</span>
        <span class="nav-fleet">{{ fleet.brand.label | default: "CANONIC" }}</span>
      </button>
    </div>
    <div class="nav-center">
      <a href="{{ page.back_href | default: '/PAPERS/' | relative_url }}" class="nav-back">&larr; {{ page.back_label | default: scope_up }}</a>
    </div>
    <div class="nav-right">
      {% if page.talk %}<button class="nav-talk" type="button" onclick="TALK.open()" aria-label="Open TALK">
        <span class="nav-dot"></span>
        <span class="nav-talk-label">TALK</span>
      </button>{% endif %}
      {% if page.gate == "contribute" %}<a href="#Contribute" class="nav-ctrl" title="Contribute to this paper">CONTRIBUTE</a>{% endif %}
      {% if page.view %}
      <button class="nav-ctrl nav-view" type="button"
        data-view="{{ page.view }}" onclick="CONTROLS.view(this)" title="Toggle view">
        {{ page.view | upcase }}
      </button>
      {% endif %}
      <button class="nav-theme" type="button" onclick="toggleTheme()" id="theme-btn" title="Toggle light/dark">&#9790;</button>
    </div>
    {% if fleet.sites %}
    <div class="nav-dropdown" id="navDropdown">
      <div class="nav-dropdown-section">
        <div class="nav-dropdown-label">FLEET</div>
        <div class="nav-dropdown-links">
          {% for s in fleet.sites %}<a href="{{ s.url }}"{% if s.scope == site.scope %} class="active"{% endif %}>{{ s.label | default: s.scope }}</a>{% endfor %}
        </div>
      </div>
    </div>
    {% endif %}
  </header>

  {% if page.gate == "contribute" %}
  <!-- CONTRIBUTE GATE: identity required before any content renders -->
  <div class="gate-contribute" id="gate">
    <div class="gate-inner">
      <p class="gate-text">Tell us who you are to read, explore, and contribute. Your identity is logged with provenance. Open access. Governed record.</p>
      <form class="gate-form" id="gateForm">
        <input type="text" id="g-name" placeholder="Full Name" required>
        <input type="email" id="g-email" placeholder="Email" required>
        <input type="text" id="g-affiliation" placeholder="Affiliation" required>
        <button type="submit" class="btn">ENTER</button>
      </form>
    </div>
  </div>
  <div class="gated-content" id="gatedContent">
  {% endif %}

  <!-- PDF VIEWER: tex view (hidden by default — HTML is always the default view) -->
  {% if page.pdf %}
  <div id="pdfViewer" class="pdf-viewer"{% unless page.view == "tex" %} style="display:none"{% endunless %}>
    <iframe src="{{ page.pdf | relative_url }}" title="{{ page.title }} — PDF"></iframe>
  </div>
  {% endif %}

  <!-- ARTICLE: html view (default — 1-col like blog posts) -->
  <article class="post container view-md"{% if page.view == "tex" and page.pdf %} style="display:none"{% endif %}>
    <header class="post-header">
      <div class="hero-badge">{{ page.badge | default: scope_up }}</div>
      <h1 class="gradient-text">{{ page.title }}</h1>
      {% if page.date %}<time class="post-date">{{ page.date | date: "%B %d, %Y" }}</time>{% endif %}
      {% if page.author %}<span class="post-author">{{ page.author }}</span>{% endif %}
    </header>

    {% if page.figure %}
    <figure class="post-figure">
      {% assign fig = page.figure %}
      {% if fig.type == "score-meter" %}{% include figures/SCORE.html score=fig.score label=fig.label %}
      {% elsif fig.type == "pipeline" %}{% include figures/PIPELINE.html steps=fig.steps %}
      {% elsif fig.type == "audit-trail" %}{% include figures/AUDIT.html items=fig.items %}
      {% elsif fig.type == "flow-chain" %}{% include figures/FLOW.html nodes=fig.nodes %}
      {% elsif fig.type == "balance" %}{% include figures/BALANCE.html left=fig.left right=fig.right tilt=fig.tilt %}
      {% elsif fig.type == "gauge" %}{% include figures/GAUGE.html value=fig.value max=fig.max label=fig.label unit=fig.unit %}
      {% elsif fig.type == "donut" %}{% include figures/DONUT.html segments=fig.segments total=fig.total label=fig.label %}
      {% elsif fig.type == "area-chart" %}{% include figures/AREA.html points=fig.points label=fig.label prefix=fig.prefix suffix=fig.suffix %}
      {% elsif fig.type == "bar-chart" %}{% include figures/BARS.html bars=fig.bars %}
      {% elsif fig.type == "timeline" %}{% include figures/TIMELINE.html items=fig.items %}
      {% elsif fig.type == "hero-stats" %}{% include figures/HERO-STATS.html items=fig.items footer=fig.footer %}
      {% elsif fig.type == "architecture" %}{% include figures/ARCHITECTURE.html layers=fig.layers label=fig.label %}
      {% elsif fig.type == "funnel" %}{% include figures/FUNNEL.html left=fig.left left_label=fig.left_label left_items=fig.left_items bridge=fig.bridge bridge_label=fig.bridge_label bridge_sub=fig.bridge_sub right=fig.right right_label=fig.right_label right_items=fig.right_items result=fig.result %}
      {% elsif fig.type == "tier-cards" %}{% include figures/TIER-CARDS.html cards=fig.cards %}
      {% elsif fig.type == "app-grid" %}{% include figures/APP-GRID.html apps=fig.apps %}
      {% elsif fig.type == "wallet-hero" %}{% include figures/WALLET-HERO.html id=fig.id balance=fig.balance actions=fig.actions %}
      {% elsif fig.type == "transactions" %}{% include figures/TRANSACTIONS.html id=fig.id items=fig.items %}
      {% endif %}
    </figure>
    {% endif %}

    <div class="post-body paper-body prose">
      {{ content }}
    </div>

    {% if page.gate == "contribute" %}
    <div class="contribute-section" id="Contribute">
      <h2>Contribute</h2>
      <p class="contribute-sub">Have a story, a quote we missed, a correction, a moment? Every contribution is governed and attributed.</p>
      <form class="gate-form" id="contribForm">
        <input type="text" id="c-chapter" placeholder="Section or quote this relates to (optional)">
        <textarea id="c-story" placeholder="Your story, quote, or correction..." required></textarea>
        <input type="text" id="c-source" placeholder="Source (paper title, year, personal memory...)">
        <button type="submit" class="btn">SUBMIT CONTRIBUTION</button>
      </form>
      <div class="contrib-success" id="contribSuccess">
        Your contribution has been recorded with provenance. Thank you.
      </div>
    </div>
    {% endif %}
  </article>

  {% if page.gate == "contribute" %}
  </div><!-- /gatedContent -->
  {% endif %}

  <!-- FOOTER: inline (same classes as FOOTER.html) -->
  <footer id="footer">
    {% if fleet.sites %}{% for s in fleet.sites %}{% unless forloop.first %} · {% endunless %}<a href="{{ s.url }}">{{ s.label }}</a>{% endfor %}
     · <a href="#" onclick="TALK.open();return false">TALK</a>
    <br><br>{{ page.footerTagline | default: "CANONIC" }}
    {% endif %}
  </footer>

  <!-- SCRIPTS: inline (same as SCRIPTS.html — avoids deep include chain) -->
  <script src="{{ '/assets/js/theme.js' | relative_url }}"></script>
  <script src="{{ '/assets/js/nav.js' | relative_url }}"></script>
  <script src="{{ '/assets/js/figures.js' | relative_url }}"></script>
  <script src="{{ '/assets/js/controls.js' | relative_url }}"></script>
  {% if page.talk %}
  <!-- TALK (inlined) -->
  <div class="talk-overlay" id="talkOverlay" data-position="{{ page.talk | default: 'side' }}">
    <div class="talk-overlay-header">
      <div class="talk-dot"></div>
      <span class="talk-scope">{{ site.talk_label | default: "TALK" }}</span>
      <select id="talkProviderSelect" onchange="TALK.switchProvider(this.value)" class="talk-provider-select">
        <option value="auto">AUTO</option>
        <option value="anthropic">ANTHROPIC</option>
        <option value="runpod">RUNPOD</option>
        <option value="vastai">VAST.AI</option>
        <option value="deepseek">DEEPSEEK</option>
      </select>
      <span id="talkProviderLabel" class="talk-provider-label">AUTO</span>
      <button type="button" class="talk-overlay-close" onclick="TALK.close()">ESC</button>
    </div>
    <div class="talk-messages" id="talkMessages"></div>
    <div class="talk-input-row">
      <input type="text" id="talkChatInput" placeholder="{{ page.talk_placeholder | default: 'Ask anything...' }}" autocomplete="off">
      <button type="button" id="talkSend" onclick="TALK.send()">SEND</button>
    </div>
  </div>
  <script src="{{ '/assets/js/talk.js' | relative_url }}"></script>
  <script>TALK.init();</script>
  {% endif %}

  {% if page.gate == "contribute" %}
  <!-- Contribute gate script (identity + contribution form) -->
  <script>
  (function(){
    var KEY='canonic-gate-'+{{ page.scope | jsonify }};
    var stored=localStorage.getItem(KEY);
    function unlock(){document.getElementById('gate').classList.add('hidden');document.getElementById('gatedContent').classList.add('unlocked');}
    if(stored){try{var d=JSON.parse(stored);if(d&&d.name){unlock();}}catch(e){}}
    document.getElementById('gateForm').addEventListener('submit',function(e){
      e.preventDefault();
      var entry={name:document.getElementById('g-name').value.trim(),email:document.getElementById('g-email').value.trim(),affiliation:document.getElementById('g-affiliation').value.trim(),timestamp:new Date().toISOString(),scope:{{ page.scope | jsonify }}};
      localStorage.setItem(KEY,JSON.stringify(entry));
      unlock();
    });
    document.getElementById('contribForm').addEventListener('submit',function(e){
      e.preventDefault();
      var auth=JSON.parse(localStorage.getItem(KEY)||'{}');
      var contrib={scope:{{ page.scope | jsonify }},contributor:auth.name||'Anonymous',email:auth.email||'',affiliation:auth.affiliation||'',chapter:document.getElementById('c-chapter').value.trim(),story:document.getElementById('c-story').value.trim(),source:document.getElementById('c-source').value.trim()};
      function showSuccess(msg){document.getElementById('contribForm').classList.add('hidden');var s=document.getElementById('contribSuccess');if(msg)s.textContent=msg;s.classList.add('unlocked');}
      fetch('https://api.canonic.org/contribute',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(contrib)}).then(function(r){return r.json()}).then(function(d){if(d.ok){showSuccess();}}).catch(function(){var local=JSON.parse(localStorage.getItem(KEY+'-contributions')||'[]');contrib.timestamp=new Date().toISOString();contrib.offline=true;local.push(contrib);localStorage.setItem(KEY+'-contributions',JSON.stringify(local));showSuccess('Saved offline. Will sync when reconnected.');});
    });
  })();
  </script>
  {% endif %}

  <!-- Mermaid (inlined, theme-reactive) -->
  <script type="module">
    import mermaid from '{{ site.data.deps.mermaid.esm }}';
    const sources=new Map();
    document.querySelectorAll('code.language-mermaid').forEach(c=>{
      const d=document.createElement('div');
      d.classList.add('mermaid');
      d.textContent=c.textContent;
      sources.set(d,c.textContent);
      c.parentElement.replaceWith(d);
    });
    function getTheme(){return document.documentElement.getAttribute('data-theme')==='light'?'default':'dark';}
    mermaid.initialize({startOnLoad:true,theme:getTheme()});
    new MutationObserver(function(){
      mermaid.initialize({startOnLoad:false,theme:getTheme()});
      document.querySelectorAll('.mermaid').forEach(function(el){
        const src=sources.get(el)||el.getAttribute('data-mermaid-source')||el.textContent;
        if(!src)return;
        el.removeAttribute('data-processed');
        el.innerHTML=src;
        sources.set(el,src);
      });
      mermaid.run({nodes:document.querySelectorAll('.mermaid')});
    }).observe(document.documentElement,{attributes:true,attributeFilter:['data-theme']});
  </script>
</body>
</html>
