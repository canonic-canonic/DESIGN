<!-- LAYOUT: post | Unified viewer | DESIGN.md 255 Map -->
<!-- All labels resolve from: page front matter → scope data → scope name -->
{% assign scope_key = page.scope | default: site.scope | downcase %}
{% assign sd = site.data[scope_key] %}
{% assign scope_up = page.scope | default: site.scope | upcase %}
{% assign back_label = page.back_label | default: sd.back_label | default: scope_up %}
{% assign back_href = page.back_href | default: sd.back_href %}
{% assign badge_label = page.badge | default: sd.badge_label | default: scope_up %}
<!DOCTYPE html>
<html lang="en" data-scope="{{ page.scope | default: site.scope | downcase }}">
<head>
  {% include HEAD.html title=page.title description=page.description %}
</head>
<body class="post-page">

  {% include NAV-UNIFIED.html mode="post" back_href=back_href back_label=back_label scope_label=scope %}

  <article class="post container">
    <header class="post-header{% if page.hero.cover %} post-header-cover{% endif %}">
      {% if page.hero.cover %}
      <div class="post-cover">
        <img src="{{ page.hero.cover }}" alt="{{ page.title }} cover art" loading="lazy"/>
      </div>
      <div class="post-header-text">
      {% endif %}
        <div class="hero-badge">{{ page.badge | default: badge_label }}</div>
        <h1 class="gradient-text">{{ page.title }}</h1>
        {% if page.hero.description %}<p class="post-description">{{ page.hero.description }}</p>{% endif %}
        {% if page.date %}<time class="post-date">{{ page.date | date: "%B %d, %Y" }}</time>{% endif %}
        {% if page.author %}<span class="post-author">{{ page.author }}</span>{% endif %}
      {% if page.hero.cover %}
      </div>
      {% endif %}
    </header>

    {% include CONTROLS.html %}

    {% if page.figure %}
    <figure class="post-figure">
      {% assign fig = page.figure %}
      {% if fig.type == "score-meter" %}{% include figures/SCORE.html score=fig.score label=fig.label %}
      {% elsif fig.type == "pipeline" %}{% include figures/PIPELINE.html steps=fig.steps %}
      {% elsif fig.type == "audit-trail" %}{% include figures/AUDIT.html items=fig.items %}
      {% elsif fig.type == "flow-chain" %}{% include figures/FLOW.html nodes=fig.nodes %}
      {% elsif fig.type == "balance" %}{% include figures/BALANCE.html left=fig.left right=fig.right tilt=fig.tilt %}
      {% elsif fig.type == "gauge" %}{% include figures/GAUGE.html value=fig.value max=fig.max label=fig.label unit=fig.unit %}
      {% elsif fig.type == "donut" %}{% include figures/DONUT.html segments=fig.segments total=fig.total label=fig.label %}
      {% elsif fig.type == "area-chart" %}{% include figures/AREA.html points=fig.points label=fig.label prefix=fig.prefix suffix=fig.suffix %}
      {% elsif fig.type == "bar-chart" %}{% include figures/BARS.html bars=fig.bars %}
      {% elsif fig.type == "timeline" %}{% include figures/TIMELINE.html items=fig.items %}
      {% elsif fig.type == "hero-stats" %}{% include figures/HERO-STATS.html items=fig.items footer=fig.footer %}
      {% elsif fig.type == "architecture" %}{% include figures/ARCHITECTURE.html layers=fig.layers label=fig.label %}
      {% elsif fig.type == "funnel" %}{% include figures/FUNNEL.html left=fig.left left_label=fig.left_label left_items=fig.left_items bridge=fig.bridge bridge_label=fig.bridge_label bridge_sub=fig.bridge_sub right=fig.right right_label=fig.right_label right_items=fig.right_items result=fig.result %}
      {% elsif fig.type == "tier-cards" %}{% include figures/TIER-CARDS.html cards=fig.cards %}
      {% elsif fig.type == "app-grid" %}{% include figures/APP-GRID.html apps=fig.apps %}
      {% elsif fig.type == "wallet-hero" %}{% include figures/WALLET-HERO.html id=fig.id balance=fig.balance actions=fig.actions %}
      {% elsif fig.type == "transactions" %}{% include figures/TRANSACTIONS.html id=fig.id items=fig.items %}
      {% endif %}
    </figure>
    {% endif %}

    {% if page.gate == "contribute" %}
    <!-- Contribution gate -->
    <div class="gate-contribute" id="gate">
      <div class="gate-inner">
        <p class="gate-text">Tell us who you are to read, explore, and contribute. Your identity is logged with provenance. Open access. Governed record.</p>
        <form class="gate-form" id="gateForm">
          <input type="text" id="g-name" placeholder="Full Name" required>
          <input type="email" id="g-email" placeholder="Email" required>
          <input type="text" id="g-affiliation" placeholder="Affiliation" required>
          <button type="submit" class="btn">ENTER</button>
        </form>
      </div>
    </div>
    <div class="gated-content" id="gatedContent">
    {% endif %}

    <div class="post-body prose">
      {{ content }}
    </div>

    {% if page.gate == "contribute" %}
    <!-- Contribution form -->
    <div class="contribute-section">
      <h2>Contribute</h2>
      <p class="contribute-sub">Have a story, a quote we missed, a correction, a moment? Every contribution is governed and attributed.</p>
      <form class="gate-form" id="contribForm">
        <input type="text" id="c-chapter" placeholder="Chapter or quote this relates to (optional)">
        <textarea id="c-story" placeholder="Your story, quote, or correction..." required></textarea>
        <input type="text" id="c-source" placeholder="Source (talk title, year, personal memory...)">
        <button type="submit" class="btn">SUBMIT CONTRIBUTION</button>
      </form>
      <div class="contrib-success" id="contribSuccess">
        Your contribution has been recorded with provenance. Thank you.
      </div>
    </div>
    </div><!-- /gatedContent -->
    {% endif %}

    {% if page.proof %}
    {% include PROOF.html type="closing" quote=page.proof.quote sig=page.proof.sig cta=page.proof.cta %}
    {% endif %}
  </article>

  <footer id="footer">{% include FOOTER.html %}</footer>

  {% include SCRIPTS.html %}
  <script type="module">
    import mermaid from '{{ site.data.deps.mermaid.esm }}';
    document.querySelectorAll('code.language-mermaid').forEach(c=>{
      const d=document.createElement('div');
      d.classList.add('mermaid');
      d.textContent=c.textContent;
      c.parentElement.replaceWith(d);
    });
    mermaid.initialize({startOnLoad:true,theme:document.documentElement.classList.contains('dark')?'dark':'default'});
  </script>
  {% if page.gate == "contribute" %}
  <script>
  (function(){
    var KEY='canonic-gate-'+{{ page.scope | jsonify }};
    var stored=localStorage.getItem(KEY);
    function unlock(){document.getElementById('gate').classList.add('hidden');document.getElementById('gatedContent').classList.add('unlocked');}
    if(stored){try{var d=JSON.parse(stored);if(d&&d.name){unlock();}}catch(e){}}
    document.getElementById('gateForm').addEventListener('submit',function(e){
      e.preventDefault();
      var entry={name:document.getElementById('g-name').value.trim(),email:document.getElementById('g-email').value.trim(),affiliation:document.getElementById('g-affiliation').value.trim(),timestamp:new Date().toISOString(),scope:{{ page.scope | jsonify }}};
      localStorage.setItem(KEY,JSON.stringify(entry));
      unlock();
    });
    document.getElementById('contribForm').addEventListener('submit',function(e){
      e.preventDefault();
      var auth=JSON.parse(localStorage.getItem(KEY)||'{}');
      var contrib={scope:{{ page.scope | jsonify }},contributor:auth.name||'Anonymous',email:auth.email||'',affiliation:auth.affiliation||'',chapter:document.getElementById('c-chapter').value.trim(),story:document.getElementById('c-story').value.trim(),source:document.getElementById('c-source').value.trim()};
      function showSuccess(msg){document.getElementById('contribForm').classList.add('hidden');var s=document.getElementById('contribSuccess');if(msg)s.textContent=msg;s.classList.add('unlocked');}
      fetch('https://api.canonic.org/contribute',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(contrib)}).then(function(r){return r.json()}).then(function(d){if(d.ok){showSuccess();}}).catch(function(){var local=JSON.parse(localStorage.getItem(KEY+'-contributions')||'[]');contrib.timestamp=new Date().toISOString();contrib.offline=true;local.push(contrib);localStorage.setItem(KEY+'-contributions',JSON.stringify(local));showSuccess('Saved offline. Will sync when reconnected.');});
    });
  })();
  </script>
  {% endif %}
</body>
</html>
